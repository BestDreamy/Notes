# 蜂鸟E203的配套SoC设计

该SoC可以在蜂鸟e200的开源库中的/rtl/e203/soc目录下找到，目录下的文件是整个蜂鸟e203的顶层文件，外设相关verilog代码在perips目录下，时钟、总线和其他内容在subsys目录下

基于Freedom E310 SoC进行二次开发

系统的SoC设计如下图所示

![http://14901018.s21i.faiusr.com/4/ABUIABAEGAAg8qiqgAYo_JSj5gIwkwM4-wE.png](RISC-V学习笔记【配套SoC简介】.assets/ABUIABAEGAAg8qiqgAYo_JSj5gIwkwM4-wE.png)

## 存储资源

1. ITCM指令紧耦合存储器：RISC-V处理器内核私有指令存储器

   有以下特性

   * 大小、地址区间（默认起始地址0x8000_0000）可配置
   * 可用Load和Store指令访问，因此可以存储数据

2. DTCM数据紧耦合存储器：RISC-V处理器内核私有数据存储器

   有以下特性

   * 大小、地址区间（默认起始地址0x9000_0000）可配置
   * 只能用于存储数据

3. ROM

   有以下特性

   * 挂载在系统存储总线上
   * 大小4kB
   * 默认仅存放一条跳转指令，直接跳转到ITCM的起始地址位置开始执行

还可以扩展片外存储设备，一般使用FLASH存储

外部FLASH可以使用其XiP（Execution in Plae）模式，通过QSPI0映射为一片只读的地址区间（0x20000_0000到0x3FFF_FFFF）

也可以使用调试器将程序直接烧写在FLASH中，利用XiP模式就可以直接从FLASH中启动

## 时钟域和电源域

整个SoC划分为3个时钟域

1. **常开域**

   使用低速32.768kHz时钟，可以选择片上振荡器、外部晶振、芯片引脚输入

   蜂鸟E203 SoC中使用LCLKGEN模块控制常开域的时钟

   **在FPGA移植时应该注意该模块为空，需要直接输入32.768kHz时钟或自行编写PLL模块**

2. **主域**

   可以使用片上振荡器、外部晶振和片上PLL来生成高速时钟

   芯片主体时钟，使用HCLKGEN模块生成

   **FPGA开发板中，HCLKGEN模块为空，直接输出16MHz的参考时钟**

3. **调试域**

   专用于支持JTAG调试，由JTAG时钟和RISC-V内核时钟组成，内部由异步时钟跨越处理

整个SoC划分为2个电源域

1. **常开域**

   为子模块LCLKGEN、看门狗、RTC和PMU外设供电

2. **MOFF域**

   为常开域外所有主体部分供电

整个SoC可以有3种电源模式

1. 正常模式

   常开域、MOFF域都供电

   正常工作，可以配置HCLKGEN的PLL在低速运行来节省功耗

2. 等待模式

   正常供电，但处理器停止运行，内核时钟关闭直到被唤醒

   使用WFI指令进入该模式

3. 休眠模式

   常开域正常供电，MOFF域断电

   配置PMU的PMUSLEEP寄存器进入休眠模式，直到PMU定义的唤醒条件唤醒

特别注意：**FPGA开发板上没有真正的电源域功能**

## 复位

全片有3个全局复位来源

1. POR电路

   上电复位

   上电前直到电压稳定，POR电路会一直输出复位信号来保证芯片正常上电

   上电复位后可以通过调节BOOTROM_N引脚来实现不同的启动方式

   1. PC复位到0x2000_0000，从外部FLASH执行
   2. PC复位到0x0000_1000，从内部ROM执行固定代码，执行完毕后直接跳转到ITCM的0x8000_0000继续执行

2. 复位引脚AON_ERST_N

3. 看门狗生成的Reset信号

   没有及时喂狗就会导致软件复位

复位信号流向如下：

三种全局复位源信号经或门后称为aonrst信号，作为Always-On模块本身的复位信号，用于复位常开域的外设。在常开域外设PMU被复位后会执行默认的唤醒指令序列，进而唤醒整个SoC复位，PMU执行默认的唤醒之林序列生成hclkrst和corerst信号。如名称一样，会分别复位HCLKGEN模块和其他主域外设及CPU

## GPIO

蜂鸟E203附带的SoC提供了共一组32个IO口的GPIO外设，每个IO都支持：

* 上拉、下拉、悬空
* 输入、输出使能
* 输入读取、输出值读取
* 输出驱动强度控制
* 两种控制模式：软件控制和IOF（硬件IO）控制模式

软件模式下，通过读写GPIO的外设控制寄存器来执行外设控制

硬件模式下，某IO受IOF接口信号控制，IOF接口包含输入使能IE、输出使能OE、输入信号寄存器IVAL、输出信号寄存器IVAL四个数据位，IOF由来可以选择IOF1、IOF2，这个要通过软件读写外设寄存器来配置

**硬件模式**的IOF0和IOF1实际上用于连接E203 SoC中其他外设的片上接口，起到类似STM32中GPIO**复用**的功能

相关复用分配表如下所示：

| GPIO IO号 | IOF0           | IOF1   |
| --------- | -------------- | ------ |
| 0         | -              | PWM0_0 |
| 1         | -              | PWM0_1 |
| 2         | QSPI1:SS0      | PWM0_2 |
| 3         | QSPI1:SD0/MOSI | PWM0_3 |
| 4         | QSPI1:SD1/MISO | -      |
| 5         | QSPI1:SCK      | -      |
| 6         | QSPI1:SD2      | -      |
| 7         | QSPI1:SD3      | -      |
| 8         | QSPI1:SS1      | -      |
| 9         | QSPI1:SS2      | -      |
| 10        | QSPI1:SS3      | PWM2_0 |
| 11        | -              | PWM2_1 |
| 12        | IIC:SDA        | PWM2_2 |
| 13        | IIC:SCL        | PWM2_3 |
| 14        | -              | -      |
| 15        | -              | -      |
| 16        | UART0:RX       | -      |
| 17        | UART0:TX       | -      |
| 18        | -              | -      |
| 19        | -              | PWM1_0 |
| 20        | -              | PWM1_1 |
| 21        | -              | PWM1_2 |
| 22        | -              | PWM1_3 |
| 23        | -              | -      |
| 24        | UART1:RX       | -      |
| 25        | UART1:TX       | -      |
| 26        | QSPI2:SS       | -      |
| 27        | QSPI2:SD0/MOSI | -      |
| 28        | QSPI2:SD1/MISO | -      |
| 29        | QSPI2:SCLK     | -      |
| 30        | QSPI2:SD2      | -      |
| 31        | QSPI2:SD3      | -      |

## 中断

中断部分可以参考【中断和异常】部分

这里单独说明GPIO中断

GPIO的每个IO都能根据IVAL信号产生不同类型的中断，包括以下：

* 上升沿触发
* 下降沿触发
* 高电平触发
* 低电平触发

对于每个IO口，上述4种中断通过一个**或**门最终产生一根中断线，所以说GPIO外设中共可以产生32个中断信号，这些中断信号都会作为SoC中PLIC的外部中断源

## 总线控制器

### IIC控制器

IIC Master：IIC主控制模块







### SPI控制器









### UART控制器

蜂鸟E203





## PWM控制器







## 其他外设

### WDT看门狗定时器







### RTC实时时钟











## 总结

虽然看起来很厉害，但是蜂鸟E203的配套外设确实没有STM32那么多（毕竟SoC和内核加起来才占20k+的LUT，还要什么自行车）

往小了说这就是个大号51——虽然它能在FPGA上跑到200MHz主频

往大了说——这就叫可扩展性强，你想要啥就写啥然后弄成IP核挂到片内总线上，甚至还嫌这个小SoC里面其他外设占地方=_=

蜂鸟这个SoC比较好的地方就是官方提供了一套驱动函数库（或者说标准外设库？），可以很方便地编程

这篇博文发布的时候我的集创赛应该也完事了，如果不出意外的话那就是-300的悲惨结局——从头开始掉坑

也许以后有空会专门写一篇博文总结一下这次集创赛的踩坑经历吧......

以上