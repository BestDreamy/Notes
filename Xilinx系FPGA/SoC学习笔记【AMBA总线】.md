# AMBA总线规范

AMBA规范由AR公司制定，用于SoC内IP互联

AMBA即（Advanced Microcontroller Bus Architecture，AMBA）规范是一种开放式标准片上互联规范，用于连接和管理片上系统中的各个功能模块（IP）

AMBA中有以下几个主要接口：

* 高级外设总线APB：用于低速低功耗外设连接
* 高级高性能总线AHB：用于高速外设连接
* 高级可扩展接口AXI：最普遍使用的高性能总线
* 高级跟踪总线ATB：用于在芯片外围移动跟踪数据
* AXI一致性扩展接口ACE：用于移动设备的大小核之间高速连接
* 相关集线器接口CHI：用于网络和服务器设备的高带宽高性能数据传输

## APB规范

**在APB总线中，唯一的主机为APB总线桥，其它外设都是从机**。因此APB总线不需要有一个像AHB一样的仲裁器以及其它控制器，因此通常APB总线可看做由**APB总线桥**和**APB上的从设备**两部分组成。APB总线通常是AHB或者ASB系统总线（已经过时的总线）的扩展，便于外设链接到系统总线上，AHB和APB之间就使用APB总线桥来链接

APB规定**所有信号必须在时钟上升沿进行传递**

APB总线包含8根信号线：

* **PCLK**：总线时钟，由总线时钟源提供
* **PRESETn**：复位信号，低电平有效，由系统总线复位信号提供
* **PADDR**：总线地址信号，由外设APB总线桥提供
* **PPROT**：保护信号，用于表示普通的、剥夺的或安全保护级别
* **PSELx**：总线选择信号，该信号表示选中某个从设备，*每个从设备都应该有一个PSELx信号*
* **PENABLE**：总线数据传输使能，用于触发APB总线的访问周期
* **PWRITE**：总线访问方向信号，信号拉高表示APB写访问；信号拉低表示APB读访问
* **PWDATA**：写数据信号，使用该信号线驱动写数据总线
* **PRDATA**：读数据信号，在读周期时从所选择的从设备驱动该总线，宽度受限（最高32位）
* **PSTRB**：写选通信号，用于表示写传输时更新哪个字节通道。每8位使用一个PSTRB信号线控制。在读传输时，写选通信号不活动
* **PREADY**：总线准备信号，从设备控制该信号来扩展APB传输
* **PSLVERR**：总线错误信号，用于表示传输失败。外设可以不使用PSLVERR引脚，在外设不包含该引脚时，APB桥的数据应适当拉低

以上总线结构可以和下文相互参考理解

### 读写时序

1. 无等待状态写
    1. 需要一个**建立周期**寄存PADDR、PWDATA、PWRITE、PSEL，这些信号会在PCLK上升沿完成寄存
    2. 在第二个周期，PENABLE和PREADY寄存，PENABLE表示传输**访问周期**开始；PREADY表示PCLK的下一个上升沿从设备可以完成传输
    3. 第三个周期完成之前，PADDR、PWDATA和控制信号会一直保持有效
    4. 第四个周期，PENABLE和PSEL变成无效，等待下一个传输开始
    
    ![img](SoC学习笔记【AMBA总线】.assets/20200511103914209.png)
    
2. 有等待状态写

    1. 在访问周期开始时，PENABLE为高时，可以通过拉低PREADY来扩展传输
    2. PREADY拉低后，可以添加两个传输周期
    3. 新添加的周期也可以是有等待状态的，即可以通过拉低PREADY来无限延长传输周期

3. 无等待状态读

    基本时序和无等待状态写类似，但是使用PRDATA作为信号传输线，在读传输结束之前，从设备必须主动提供数据

    ![img](SoC学习笔记【AMBA总线】.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5ZndpbGw=,size_16,color_FFFFFF,t_70.png)

4. 有等待状态读

    与有等待状态写类似，可以通过拉低PREADY来实现延长传输周期

事实上，除了写信号有效性相反外，APB读操作时序和写操作时序非常相似。特别地，如果写操作之后跟随着读操作或者相反，那么需要 3个等待周期来完成读操作。通常的情况下，不会有读操作之后紧跟着写操作的发生，因为两者之间CPU会进行取指操作——更重要的是指令存储器不太可能直接挂在APB总线上

### 错误响应

传输中使用*PSLVERR*信号来指示APB总线传输的错误条件。

为了防止读写交易过程中发生错误，当PSEL、PENABLE、PREADY都为高时，PSLVERR有效

当外设接收到一个错误时，写交易并不会更新外设内的寄存器；而当读交易能够返回无效的数据，对于读错误，并不会要求外设将数据总线驱动置0

### APB控制状态机

![blob.png](SoC学习笔记【AMBA总线】.assets/1000019445-6369948876516550714068695.png)

APB总线状态机如上图所示

* **IDLE**：空闲状态，APB总线默认处于此状态
* **SETUP**：建立状态，当请求传输时，PSEL=1。在一次传输中，该状态只会保留一个时钟周期
* **ACCESS**：访问状态，PSEL=1，PENABLE=1。要求地址信号、选择信号、读/写数据信号保持不变。准备信号PREADY决定了是否从ACCESS状态退出（PREADY=0，保持；PREADY=1，退出，如果此使没有其他传输请求，就返回IDLE，否则继续进入SETUP）

APB的每次传输均需**消耗2个周期的时间**

## AHB规范

APB总线用于低速低功耗的情况，一般只是用他来控制外设的寄存器；而AHB总线则通常用于更高速的情况——基于ARM核的MCU一般都使用AHB连接内核和APB总线。

![一个典型的AHB系统总线的结构示意图](SoC学习笔记【AMBA总线】.assets/123F15311_0.png)

如上图所示，典型AMBA总线系统就是这样，ARM核、片上RAM、DTCM/ITCM等高带宽内存、DMA设备这些需要高速传输的设备挂载到AHB总线上；APB总线连接低速的定时器、GPIO、串口、片外总线控制器等外设；AHB总线和APB总线间通过总线桥相连不过近年来，随着外设和片外总线速度越来越高（MCU逐渐整合DSP功能），一些高速定时器、高速GPIO都会被直接挂载到AHB总线上













## AXI4规范

AHB总线和APB总线相关内容可以参考知乎上面@[桔里猫](https://www.zhihu.com/people/orangeofcat)的[简介](https://zhuanlan.zhihu.com/p/157808097?from_voters_page=true)，本博文也参考了一部分

下面再介绍现代FPGA中常用的AMBA总线：AXI4总线

