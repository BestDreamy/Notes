> 本博文参考胡伟武《计算机体系结构基础》、P-H《计算机组成与设计-硬件/软件接口（RISC-V版）》《计算机体系结构：量化研究方法》和Bryant《深入理解计算机系统》写作。笔者系初学，如有错误敬请指正。

# 计算机体系结构笔记0【计算机抽象】

本篇博文主要基于“抽象”这个线索，探讨计算机分类、结构、性能的*量化*描述，基本对应于上面所述参考教材的第一章、第二章

计算机是一套非常复杂的系统，它的理论基础来源于香农的信息论和*图灵机*：是对人类进行计算行为的模仿。从中衍生出的*冯诺依曼架构*和*哈佛架构*解决了这些数学模型不能在电子电路中运行的问题，电子计算机从抽象的数学概念变成可以分模块构建的设备。数字电路和数学理论构成了计算机的最底层——计算架构，其他计算机设备都是在其基础上发展而来。但很显然程序员不用考虑CPU内部的门电路是怎么执行一条if语句，芯片IP设计者也不需要考虑上层的Windows怎么读写自己的外设，这都是因为计算机采用了**抽象**的设计思想。

抽象是计算机结构中的最核心思想，它与*分层*思想、*封装*思想一般同时使用。随着计算机底层资源（单芯片上的晶体管数目）随**摩尔定律**发生指数级性能提升，成本快速下降，上层的硬件电路和软件程序复杂度也会显著增长，对应的设计时间也会显著延长。为了上层开发者能够保持高效开发，抽象、分层、封装、虚拟化乃至软件工程的理论开始出现。

抽象就是将底层的实现细节隐藏封装起来，高层只需要使用它提供的一套简单模型和操作接口就可以实现需要的功能。这里还需要提到**分层**概念，计算机是像金字塔一样的层叠结构，基础的板级硬件电路和芯片上集成电路构成了最底层，还有通过各种协议和接口与主体连接的外部设备；更上一层是片上的核心部件CPU及与他紧耦合的电路设备；电路和软件通过ISA指令集体系结构连接，对应的机器码或者说汇编语言构成了这一层，它们是软件和硬件的桥梁；操作系统作为CPU的“驱动程序”，与转换高级语言和汇编语言的编译器处在更高一层；在其之上则是应用软件和更能被软件开发者理解的高级语言。

在计算机体系结构中，抽象无处不在，而抽象带来的效果就是**虚拟化**。虚拟化直白说就是“上层看上去是这样，底层的执行实际上是那样”，利用虚拟化就可以将底层的功能和上层的功能分离开。这个理论相对复杂，这里暂且放下，我们先回到更实际的东西上。

## 计算机性能的抽象和量化描述

在深入理解计算机系统之前，先考虑一个抽象的计算系统——图灵机。图灵机的概念就不提了，我们可以发现它存在一个理论上的计算瓶颈：完全顺序计算。一台图灵机的性能取决于其移动纸带的速度+向纸带上记录的速度+执行计算的速度；反映到冯氏计算机乃至一个实际的CPU（带有存储器和IO），计算速度就被这样加载一个数据-处理一个数据-输出一个数据的计算模式限制了

一个小学生做10道计算题，他会算得很慢，需要10分钟做完。我们要想让计算的速度提升，有下面几种方法：

* 换一个高中生来做计算题，可能只要5分钟就能做完
* 让2个小学生同时做题，一人负责5道，只需要5分钟就能做完
* 让小学生提前学习做题方法，就能用7分钟做完

也就对应了：提升硬件效率、并行计算、改善算法三种加快计算的途径

### 计算机分类

要探讨计算机的性能概念，我们首先得按照功能和工作领域把计算机进行分类——计算机如此深入我们的生活，每一类计算机都有自己的性能指标

**响应时间**又称为**执行时间**，描述一个程序执行完毕的时间；**吞吐量（吞吐率）**又称为**带宽**，描述了在单位时间内能够完成的任务数；**实时性**表示在一个突发情况发生后，设备能够在多长时间之内完成需要的处理动作；**可靠性**又被称为**鲁棒性**，表示机器能够稳定运行的时间和应对设备工作条件变化的能力

* 嵌入式设备

    身边随处可见的计算机，一般以MCU、DSP或者小SoC为体现，通常不需要太高的运算速度，但是需要**低功耗**、高**实时性**、高**安全性**和极**低故障率**。通常使用简单的算法和冗余设计来保障鲁棒性强。通过高度集成来降低工作电压，从而保证低功耗。CPU主频不会很高，但也不能太低，一般都在10M~1GHz之间，这样能保证设备具有很高的实时性，功耗也不太高。存储器一般和CPU封装在一起，还会加入安全协议来保证程序不被轻易读取乃至破解。设备启动速度非常快，这样能保证一旦通电就可以开始工作

* 个人移动设备

    随着智能手机普及，个人移动设备中的SoC逐渐成为主流的计算机形态。这种设备会将CPU、存储器、IO、外设乃至传感器、射频设备、GPU、NPU、硬件加速器等等封装在一起以节省外部PCB面积。设备的CPU主频一般在1G~3GHz之间，能够承担一些基本的运算任务，某些针对高性能设计的CPU还能够处理简单的多媒体和科学计算。从这里开始设备以**响应时间**为主要目标。

* 桌面计算（PC）

    桌面计算比个人移动设备的**响应时间**要更低，从而能处理复杂的办公、多媒体、科学计算任务。传统的计算机就是指桌面计算平台，由分立的CPU、GPU、DDR、硬盘、电源等设备构成。随着摩尔定律演变和芯片集成化趋势，桌面计算机也越来越小，从早期和桌子一样大的PC逐渐演变成MATX、ITX规格的小型主板主机，占地仅有机顶盒大小

* 服务器

    数据中心里面一个一个的柜子里面放着的就是服务器，最便宜的服务器和一台PC差不多价格，但是它更强调**吞吐率**，或者说**带宽**而不是响应时间。服务器往往可以能在给定时间内完成更多任务，其响应时间不一定比同价位的PC更快。一台服务器往往会采用多CPU、大量内存的结构来应对大规模数据涌入，很多时候不会搭配有图形界面（甚至没有显示设备），只能通过串口或者以太网访问。服务器的**可靠性**也很重要，PC或者手机死机只会让人无能狂怒凿穿键盘，但服务器宕机很有可能造成网站停摆、公司被迫停工乃至大规模数据泄露

* 边缘计算中心

    随着计算机发展，小型设备的计算性能逐渐增加。出于摩尔定律放缓的态势，各大厂商都在尝试从通用计算走向专用计算。FPGA、GPGPU这些设备没有同水平的CPU那样的通用计算性能，但对某些特殊领域的计算更加擅长，因此企业会在更接近用户的位置部署边缘计算平台，使用算法特化的FPGA、GPGPU等设备来满足某些特殊需求，比如自动驾驶（特斯拉里面的GPU就是一个边缘计算中心）。这种设备的性能需求**与要执行的工作有关**——自动驾驶汽车里面的GPU要求高响应时间，CPU要求高实时性和安全性；学校机房里的设备则更需要可靠性和吞吐量

* 计算机集群/仓储式计算机

    大量服务器通过数据背板或分布式网络组成一个集群，这就是仓储式计算机。大量服务器通过虚拟化技术，将它们的计算力合并起来，再分配到一个个虚拟机中，根据虚拟化技术不同和用户需求可以完成桌面计算到数据中心计算的多种用途。但其中硬件总的来说需要比一般服务器更高的**吞吐量**和**安全性**、**可靠性**

* 超级计算机（超算）

    针对高端科学工程计算而设计的服务器，往往代表了最高的通用计算能力，其**响应时间**、**吞吐量**、**可靠性**都是顶级的

* 云计算设备

    传统服务器逐渐被云计算所取代。大量仓储式计算机构成的巨型数据中心通过计算机集群和虚拟化技术，将海量计算资源出租给公司或个人。一些大公司会将云计算作为自己的扩展业务，向其他厂家提供云端的服务器租赁业务。云计算对于**可靠性**的需求极高，因为一旦服务器出问题，会有大量相关企业受害，一般会采取多机热备、异地容灾措施，一旦有服务器掉线就要有人去进行维护

可以发现，**响应时间**、**吞吐量**、**实时性**、**可靠性**是衡量计算设备的四个主要维度，而在PC、个人移动设备和服务器这三个主流计算机形式中，完全可以以响应时间和吞吐量作为衡量计算机性能的标准。

吞吐量和响应时间不是孤立的。**一般来说降低响应时间总是能增加吞吐量；但增加吞吐量并不一定能够降低响应时间**，也就是说响应时间可以相对公平地反应计算机性能

> 服务器中常见的多核架构比起PC中的单核架构并不一定提高的响应时间，只是通过增加处理器数目来应对更多数据处理需求从而增加吞吐量

### 并行架构





## 计算机性能的抽象和量化描述

对于一台计算机，我们可以用下面公式衡量他的性能（响应时间）
$$
性能=\frac{1}{执行时间}
$$
如果要比较两台计算机的性能，只需要比较它们执行相同程序的时间，其中较短的那个性能就更好。一般可以使用执行速度的倍数n来进行性能比较
$$
n=\frac{性能X}{性能Y}=\frac{执行时间Y}{执行时间X}
$$
根据这个指标，**同样计算任务负载下完成任务所需时间最少的计算机是最快的**。但是由于计算机经常被共享使用——多用户、多程序的条件下，计算机性能优化也可以通过提高吞吐量来实现，为了区分由提高吞吐量带来的性能提升和由减少单个任务的执行时间带来的性能提升，我们引入了CPU执行时间的概念

**CPU执行时间**：简称CPU时间，表示执行一个程序过程中只在CPU上花费的时间，不包括等待IO或运行其他程序中花费的时间。可以细分为**用户CPU时间**和**系统CPU时间**，用户事件表示程序本身花费的CPU时间，系统时间表示为了执行程序而花费在操作系统上的时间，二者通常难以区分，因为这与操作系统本身的功能结构有关。对应于这两个时间，可以用**系统性能**来描述空载下系统的响应时间，系统性能反映了操作系统的效率；用**CPU性能**描述用户CPU时间对应的性能表现，反映了单纯执行任务时CPU的性能

不同的应用需要关注计算机系统性能的不同方面，在服务器上的应用往往存在IO瓶颈而不是CPU瓶颈，IO速率决定了其性能下限；而嵌入式设备的应用往往不需要操作系统运行，其主要看重CPU性能，响应时间是其决定性考量因素。

### 处理器性能公式



