# 电路设计从入门到弃坑27【大规模数字电路】

之前所介绍的数字电路都是基于74门——这是最基础最宏观的数字电路组成形式，如果需要的话完全可以使用一大堆8050、8550三极管或是其他型号MOS来搭建出74门，然后再将其按功能组装成需要的电路。但很显然现在的超大规模集成电路（VLSI）和极大规模集成电路（ULSI）系统是不可能用这样的数字电路搭建的。实际上**之前所讲述的内容大都过时了**。

现代的集成电路设计者们采用计算机主导的设计工作流来“编写”而不是“绘制”数字电路。数字电路的基础元件还是那些元件，但设计流程和方法论发生了翻天覆地的变化

> 基础的数字电路理论是无法支持我们往集成电路领域探索的。从基础原件来讲，数字集成电路中的基础三极管、MOSFET器件换成了CMOS、FinFET、GAA等先进工艺——不过这些不是本篇博文要讨论的。构成数字电路最基础的逻辑门、时序电路、状态机等理论还是被沿袭下来，只不过相比于上古时代的手绘电路，现代人更倾向于使用*EDA软件*和*HDL*来“编写”电路，交给计算机处理较为模糊的*RTL*到每个逻辑门的中间映射过程，交给工艺研发人员和后端layout人员（以及EDA工具）处理每种逻辑门到基础器件之间的映射

下面最终几篇博文会基于**Verilog HDL**讨论传统的基础数字电路原理与现代的数字电路设计工作流之间的关系

## Verilog简介

首先说一下本部分参考的教程：夏宇闻老师的《Verilog数字系统设计教程》、正点原子FPGA教程、多位b站up主视频（主要为：https://www.bilibili.com/video/BV1PS4y1s7XW、https://www.bilibili.com/video/BV1oD4y1274b、https://www.bilibili.com/video/BV1S541147GB）

硬件描述语言**HDL**是一种用形式化方法来**描述**数字电路和设计数字逻辑系统的语言。它可以使数字逻辑电路设计者利用这种语言来描述自己的设计思想，然后利用电子设计自动化**EDA**工具进行仿真，并综合到门级电路，再用ASIC或FPGA实现其功能。目前常见的HDL包括

* **Verilog HDL**：本部分介绍
* **VHDL**：与Verilog同时代的HDL，常见于各大硬件厂商的底层元件库
* **SystemVerilog**：Verilog的改进版本，能够更好地进行系统级硬件描述，还引入了非常实用的验证语法，且已经被标准化，因此正在业界中与Verilog并存甚至逐渐替代传统的Verilog
* **Chisel**：基于Scala的新兴HDL，能用面向对象的语法生成Verilog网表文件，可以直接送入EDA后端运行
* **HLS**：高层次综合，直接从类似C++/OpenCL/OpenMP的语法综合成硬件电路
* **Spinal**：与Chisel类似，但更加语法贴近底层硬件描述的新兴HDL
* **myhdl**：基于Python的伪HDL，先从python语法转换成Verilog RTL文件，再进行综合，本质上不是一个HDL，但由于语法面向对象，比较适合编写测试向量仿真，常常在硬件开源项目中使用

> 到这里为止你可能还不理解什么是“**综合（synthesis）**”，只要记住这个名称就好。包括后面会遇到测试向量（TestBench）、编译、验证等等专有名词
>
> 后面会对它们尽心详细讲述

### Verilog和HDL的历史

Verilog是上世纪80年代（1983年）由Cadence的第一个合伙人Phil Moorby首创（当时任职于GDA公司）；在1984-1985年，他又提出了用于快速门级仿真的XL算法并设计出第一个关于Verilog-XL的仿真器。在1990年，Cadence决定公开Verilog HDL语言，于是成立了OVI（Open Verilog International）来负责Verilog HDL语言的发
展。IEEE于1995年制定了Verilog HDL的IEEE标准，即Verilog HDL1364-1995，这也是一直沿用至今的Verilog95标准

> 这个标准是很早期的版本，现在用得比较多的还是Verilog01标准；更新的Verilog05标准与SystemVerilog出生在同时代，基本上能被SystemVerilog替代
>
> 顺便一提，根据一位业界大佬描述，目前ARM、Nvidia、Cadence这些业界龙头中更多使用SystemVerilog的可综合部分来替代Verilog，不过Verilog仍是应用最基础最广泛的HDL

最早数字逻辑电路及系统的设计规模比较小也比较简单，其中所用到的FPGA或ASIC设计工作往往只能采用厂家提供的专用电路图输入工具来进行。工程师还需要花大量时间进行艰苦的手工布线。这种低水平的设计方法大大延长了设计周期。而采用Verilog HDL输入法时，由于Verilog HDL的**标准化**和**工艺无关性**，可以很容易地把完成的设计移植到不同的厂家的不同的芯片中去，并在不同规模应用时可以较容易地作修改。在仿真验证时，Verilog也可以进行测试向量的编写，因为里面有很多借鉴C和Pascal的语法，虽然它们是“不可综合”的，不能直接在电路描述中使用，但是可以用它们方便地编写**测试向量TestBench**

此外，**Verilog综合器生成的数字逻辑**是一种标准的电子设计互换格式（EDIF）文件，**独立于所采用的实现工艺**。有关工艺参数的描述可以通过Verilog提供的属性包括进去，然后利用不同厂家的布局布线工具，在不同工艺的芯片上实现。这使得工程师在功能设计和逻辑验证阶段可以不必过多考虑门级及工艺实现的具体细节，只需要利用系统设计时对芯片的功能需求，施加不同的约束条件，来完成电路的设计和仿真

Verilog等HDL的出现成功让数字集成电路设计的前端逻辑设计和后端实现设计解耦。这也是为什么现在很多芯片人自称“硅农”——与“码农”对应，现代芯片设计中也需要使用到大量计算机编程语言、工具和自动化脚本。同时也导致集成电路**IP**发展壮大。

> IP即知识产权。我们一般在文艺作品、发明专利中见到它，但商品、软件乃至集成电路虚拟器件和虚拟接口模型都可以作为知识产权来进行商品化，因此IP在集成电路设计领域特指能够直接拿来使用的电路设计。原初的电路设计中，IP通常指的是一张张电路图或者SPICE网表模型，而随着HDL的出现，IP也变成了*代码*的形式。
>
> 因为有了HDL，很多公司发现可以像软件公司那样为其他公司外包设计电路，并以综合好的Verilog网表形式交付IP，进而让半导体企业从最原始的IDM（设计-制造一体化）向Fabless（IP设计）发展
>
> 随着90年代GNU组织壮大和Copyleft、GPL等概念的兴起，以电路设计为领导的硬件开源运动也开始出现。IP本来是商业化、非常昂贵的，但随着越来越多人了解HDL并设计自己的电路，很多IP也以开源免费的形式发布，Verilog普及有一定功劳

把功能经过验证、可综合、实现后电路结构总门数在5000门以上的Verilog HDL模型（也可以是VHDL等由HDL实现的电路模型）称为**软核**，把由软核构成的器件称为**虚拟器件**。在新电路的研制过程中，软核和虚拟器件可以借助EDA综合工具与其它外部逻辑结合为一体。从而大大缩短设计周期，加快了复杂电路的设计。

把在某一种现场可编程门阵列（FPGA）器件上实现的，验证正确且总门数在5000门以上电路结构编码文件称为**固核**。把在某一种专用半导体集成电路工艺的（ASIC）器件上实现的，验证正确且总门数在5000门以上的电路结构掩膜称为**硬核**

### Verilog基本语法

Verilog的语法很简单，学过C语言就能理解得七七八八，但用它描述电路的难点不在于语法，而在于“**描述电路**”

Verilog最大的好处就是可以用if-else选择、for循环、数组、generate生成、define宏定义这样的高级语言描述来表达电路结构。从verilog代码到生成的电路之间还可以使用**编译器**、**综合器**进行代码逻辑和电路实现优化。但是这样一来，很多新手就只认为这是一种软件语言，没法建立从Verilog代码到实际电路之间的联系。

很多人在教新手学Verilog HDL的时候都会强调“Verilog有不同于C语言的并行化思维”、“Verilog写的是电路”、“不要把Verilog当C写”，但新手都听得迷迷糊糊——虽然Verilog确实具有这几个特点，但大伙都没说清其本质：**HDL硬件描述语言**

> 下面的内容推荐配合https://www.bilibili.com/video/BV1PS4y1s7XW一起阅读，或者先看一遍视频，再结合本文查缺补漏
>
> 本文下列部分内容也来自该视频

Verilog可以进行如下范围的硬件描述

![image-20220909105659104](电路设计从入门到弃坑27【大规模数字电路】.assets/image-20220909105659104.png)

* 系统级、算法级：统称**行为级**（Behavior Level），描述硬件的抽象行为，比如一个万年历可以用一系列if-else语句和计数器构成，Verilog可以用C那样的语法描述行为级

* 寄存器传输级：也就是常说的**RTL**（Register Transfer Level），基于寄存器reg和连线wire描述电路，比如一个多路选择器，可以用一组寄存器（存放多路选择器的选择端）和一组连线（被寄存器控制）来描述

    这一级描述不太好抽象说明，最好看后面的例程

* 逻辑门级、开关电路级：统称**器件级**，描述一个具体的逻辑门乃至开关管。Verilog代码经过编译生成的文件就是使用这一级描述的。具体使用的器件由EDA厂商的元件库决定，也就是说Verilog可以像AD、Multisim、Allegro这些板级EDA一样通过组合具体元件的形式完成数字电路设计

    这一级描述就最直观反映了“硬件描述”的特征。如果你用过SPICE描述，可能会对这一层比较熟悉，但实际上我们做设计过程中并不与这级直接打交道，所有转换工作都是由编译器和综合器完成的

正对应于这三种分类，**Verilog HDL的可综合语法可以分成三个主要板块：行为级硬件描述、RTL描述、模块例化**

Verilog除了能描述硬件，还提供了用于验证硬件设计的语法，也就是其**不可综合**部分。

**综合指的是将Verilog语法的代码转化成Verilog网表的过程**。**网表（Netlist）又称为连线表，指的是用基础逻辑门来描述数字电路的方式**，SPICE就是一种典型的网表语法，很多电路仿真工具都提供基于SPICE的仿真，但这里的网表特指数字电路设计中的**Verilog网表，是一种基于Verilog的网络**（Net，注意指的是电路分析理论意义上的网络而不是因特网）**连线描述**。

> 由于本篇讲述的主要是Verilog的语法和应用，因此不对EDA作过多展开，这里处于背景介绍再提一下
>
> 在从Verilog到电路网表乃至实际器件（光刻掩膜板）的过程中，主要需要经过以下步骤（随EDA厂家、工具链安排可能存在不同）：
>
> * 编译优化（Optimize）：对Verilog源代码按照编译器（Compiler，用于处理编译优化和编译步骤的EDA工具，和软件意义上的编译器类似）内置规则进行初步优化，并排除语法错误
> * 编译（Compile）：对Verilog代码进行处理，得到中间态代码，这样的代码更容易被综合器接受以优化综合得到的电路
> * 综合优化：按照综合器内置规则对编译后的中间态代码（仍是Verilog语法，但更加贴近底层，一般是逻辑门级描述或开关电路级描述）
> * 综合（Synthesis）：将优化后的中间态代码转换为Verilog网表的过程。一般来说可以用综合这个词来取代上面所有流程，因为上面这些过程用到的工具一般都被集成进了综合器内部。得到的Verilog网表级别是逻辑门级描述或开关电路级描述，但是与之前的中间态代码不同——中间态代码并没有使用到EDA厂商提供的器件库，也就是还是抽象的电路描述，没有映射到实际电路中；但是综合后得到的网表全部使用器件库的描述，与厂商提供的Verilog器件模型息息相关，综合使用的器件库不同会影响到后面的布局布线
> * 综合后优化：按照综合器内置规则对综合后得到的Verilog网表进行连接优化，调整得到电路的门数或连线数
> * 导入元件：根据要应用的领域确定使用什么元件——如果是IC设计则需要选用对应Fab提供的PDK；如果是仿真则需要导入EDA厂家提供的虚拟元件库；如果是在FPGA上实现则需要使用对应厂家的后端工具来根据网表选用合适的片上资源
> * 布线前优化：针对导入的元件进行网表结构微调，并按照布线工具的内部规则针对每个大模块优化内部小电路的连接
> * 布局布线：按照选用的器件进行电路布局布线，这一步通常是由后端设计人员辅助完成，设计人员指定模块的范围，EDA工具按照指定位置进行细节布线。布线工作需要消耗大量计算资源（布线是NP问题），因此会比综合慢很多倍
> * 布线后优化：根据厂商提供的工具，针对时序、片上资源消耗等进行优化









很多人说Verilog的语法非常类似**C**，但实际上Verilog与**Pascal**之间的联系也很密切





**初学者应当明确两点：尽量使用RTL级的HDL描述来避免“将芯片全盘托付给EDA工具”；简单的电路可以用波形检验，但复杂电路尽量使用验证语法来进行随机覆盖测试**













**同步时序逻辑**是指电路中寄存器的值只可能在唯一确定的触发条件发生时刻改变，使用同步时序逻辑的数字电路简称**同步电路**。同步时序逻辑的一般触发条件可以用Verilog如下描述：

```verilog
always @(posedge clock)
```

表示该always块内寄存器变量重新赋值的情形只能在clock上升沿发生。

**异步时序逻辑**是指触发条件由多个控制因素组成，任何一个因素的跳变都可以引起触发，使用异步时序逻辑的数字电路简称**异步电路**。电路中寄存器的时钟输入端不是都连结在同一个时钟信号上。例如*用一个触发器的输出连结到另一个触发器的时钟端去触发的就是异步时序逻辑*。**用Verilog设计的可综合模块必须避免使用异步时序逻辑**——不但是因为*许多综合器不支持异步时序逻辑的综合*，而且也因为*用异步时序逻辑很难控制由组合逻辑和延迟所产生的竞争和冒险*。当电路的复杂度增加时，异步时序逻辑无法调试。工艺的细微变化也会造成异步时序逻辑电路的失效。

异步时序逻辑中触发条件很随意，任何时刻都有可能发生，所以记录状态的寄存器组的输出在任何时刻都有可能发生变化。而同步时序逻辑中的触发输入至少可以维持一个时钟后再二次触发。这是一个非常重要的差别，因为我们*可以利用这一个时钟的时间在下一次触发信号来到前，为电路状态的改变创造一个稳定可靠的条件*。

> 在同步电路中，触发信号是时钟上升沿或下降沿，触发器的输入与输出是经由两个时钟来完成的，第一个时钟的上升沿（或下降沿）为输入作准备，在第一个时钟上升沿（或下降沿）到来后到第二个时钟上升沿（或下降沿）到来之前的这一段时间内，有足够的时间使输入稳定。当第二个时钟上升沿（或下降沿）到来时，由前一个时钟沿创造的条件已经稳定，所以能够使下一个状态正确地输出。
>
> 若在同一时钟的跳变沿下对寄存器组既进行输入又进行输出，很有可能由于门的延迟使输入条件还未确定时就输出了下一个状态，这会导致逻辑的紊乱。
>
> 使用同步时序的工作方式有一个前提：确定下一个状态所使用的组合电路的延迟与时钟到各触发器的差值必须小于一个时钟周期的宽度。只有满足这一前提才可以避免逻辑紊乱
>
> 实际电路中采用如下方式保证该前提成立：
>
> * 全局时钟网络布线时尽量使各分支的时钟一致
> * 采用平衡树结构，在每一级加入缓冲器，使到达每个触发器时钟端的时钟同步
>
> 通过这些措施基本可以保证时钟的同步，在后仿真时，若逻辑与预期设计的不一样，可降低时钟频率，就有可能消除由于时钟过快引起的触发器输入端由延迟和冒险竞争造成的不稳定从而使逻辑正确

因此Verilog RTL级的综合就是基于如下规定的：同步时序逻辑比异步时序逻辑具有更可靠更简单的逻辑关系，用Verilog设计可综合的电路与复杂状态机必须使用同步时序逻辑



